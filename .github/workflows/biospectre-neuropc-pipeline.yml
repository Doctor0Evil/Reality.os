name: Biospectre NeuroPC Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  bioscale-upgrade:
    runs-on: self-hosted
    env:
      BIOSPECTRE_HOST_ID: "bostrom18sd2ujv24ual9c9pshtxys6j8knh6xaead9ye7"
      BRAIN_PROFILE_ALN: "qpudatashards/particles/nstagebioscaleprofilev2.aln"
      TOKEN_PROFILE_ALN: "qpudatashards/particles/biophysicaltokenprofile.aln"
    steps:
      - name: Checkout NeuroPC
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Build Biospectre core (B1â€“B4)
        run: |
          cargo build --release -p biospectre-core
          cargo build --release -p biospectre-brain-tokens

      - name: Run B1 sleep-stage + dream inventory
        run: |
          ./target/release/biospectre-core \
            --mode nstage-inventory \
            --host-id "${BIOSPECTRE_HOST_ID}" \
            --qpudatashard "${BRAIN_PROFILE_ALN}" \
            --output qpudatashards/particles/nstagebioscaleprofile.run.aln

      - name: Run B2 brain-token scheduler
        run: |
          ./target/release/biospectre-brain-tokens \
            --mode schedule \
            --nstage-aln qpudatashards/particles/nstagebioscaleprofile.run.aln \
            --token-aln "${TOKEN_PROFILE_ALN}" \
            --output qpudatashards/particles/brain-tokens-decision.run.aln

      - name: Run B3 neural cluster orchestration
        run: |
          ./target/release/biospectre-core \
            --mode neural-cluster \
            --nstage-aln qpudatashards/particles/nstagebioscaleprofile.run.aln \
            --output qpudatashards/particles/neuralclusterprofile.run.aln

      - name: Run B4 twin governor + OTA plan
        run: |
          ./target/release/biospectre-brain-tokens \
            --mode twin-governor \
            --nstage-aln qpudatashards/particles/nstagebioscaleprofile.run.aln \
            --tokens-aln qpudatashards/particles/brain-tokens-decision.run.aln \
            --output qpudatashards/particles/ota-upgrade-plan.run.aln

      - name: Store ALN artifacts
        uses: actions/upload-artifact@v4
        with:
          name: biospectre-neuropc-run
          path: qpudatashards/particles/*.run.aln
