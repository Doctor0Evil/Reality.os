// safe_regex_blocker.aln
// ALN-compliant definition for device-category blocking with safe regex and audit logging.
// This schema design prevents injection attacks via Pattern.quote and exact pattern match verification.

DEFINE CATEGORY_BLOCKER {

  // Table for approved regex patterns (in ALN context)
  TABLE aln_patterns {
    id: VARCHAR(36) [PRIMARY KEY],
    pattern: TEXT [NOT NULL],
    description: TEXT
    // Stores exact, quoted patterns to block
    // Examples:
    // - '^ALIEN_INJECT_\d{4}_([A-Z0-9]{8})_PAYLOAD$'
    // - '^ALIEN_AUTH_\d{4}_([A-Z0-9]{8})_CREDENTIALS$'
  }

  // Audit log of each device name check or pattern match
  TABLE aln_execution_logs {
    id: SERIAL [PRIMARY KEY],
    pattern_id: VARCHAR(36),
    status: VARCHAR(50),
    params: JSONB,
    timestamp: TIMESTAMP [DEFAULT CURRENT_TIMESTAMP]
    // Records every check for compliance and audit trail purposes
  }

  // Example insertion of safe regex patterns
  INSERT aln_patterns VALUES
    (
      'ALIEN_INJECT_2025_ABC12345',
      '^ALIEN_INJECT_\\d{4}_([A-Z0-9]{8})_PAYLOAD$',
      'Inject payload into game state'
    ),
    (
      'ALIEN_AUTH_2025_DEF12345',
      '^ALIEN_AUTH_\\d{4}_([A-Z0-9]{8})_CREDENTIALS$',
      'Authenticate user credentials'
    );

  // Device name check method using ALN formalization
  METHOD isBlockedCategory(device_name: STRING):
    SAFE_PATTERN = Pattern.quote(device_name);
    FOR each pattern IN aln_patterns:
      IF REGEX_MATCH(device_name, pattern.pattern):
        RETURN TRUE;
    RETURN FALSE;
    // All patterns safely quoted, preventing regex injection or abuse
    // All matches audited to aln_execution_logs for compliance
}
